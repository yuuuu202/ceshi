# AES-SM3完整性校验算法 - 测试套件编译指南

## 🔧 编译方法（已修复main函数冲突）

### 方法1：使用自动化脚本（推荐）

```bash
# Linux/Unix/ARMv8平台
chmod +x run_tests.sh
./run_tests.sh
```

**脚本自动完成：**
- 创建库文件（去除main函数）
- 智能选择编译选项
- 编译测试程序
- 运行完整测试套件
- 清理临时文件

---

### 方法2：使用快速编译脚本

```bash
chmod +x compile_and_test.sh
./compile_and_test.sh
```

---

### 方法3：手动编译（分步执行）

```bash
# 步骤1：创建库文件（不含main函数）
head -n 3413 aes_sm3_integrity.c > aes_sm3_integrity_lib.c

# 步骤2：编译测试程序
gcc -march=armv8.2-a+crypto -O3 -funroll-loops -ftree-vectorize \
    -finline-functions -ffast-math -flto -fomit-frame-pointer -pthread \
    -o test_aes_sm3 aes_sm3_integrity_lib.c test_aes_sm3_integrity.c -lm

# 步骤3：运行测试
./test_aes_sm3

# 步骤4：清理临时文件
rm -f aes_sm3_integrity_lib.c
```

---

## ✅ 修复的问题

1. **multiple definition of 'main'** ✓
   - 解决方案：创建库文件时去除main函数

2. **implicit declaration of 'aes_sm3_parallel'** ✓
   - 解决方案：添加了函数声明

3. **undefined reference to 'SM3_IV'** ✓
   - 解决方案：使用本地SM3_IV_LOCAL常量

4. **undefined reference to 'sm3_compress_hw'** ✓
   - 解决方案：添加了extern声明

---

## 📋 测试套件包含的测试

### 第一部分：功能正确性测试（6项）
- 测试1：256位输出基本功能
- 测试2：128位输出基本功能
- 测试3：确定性测试
- 测试4：不同版本算法一致性
- 测试5：全0输入测试
- 测试6：全1输入测试

### 第二部分：安全性测试（3项）
- 测试7：雪崩效应测试
- 测试8：多点雪崩效应测试
- 测试9：输出分布均匀性测试

### 第三部分：性能基准测试（4项）
- 测试10：单块性能测试
- 测试11：不同版本性能对比
- 测试12：vs基准算法性能对比
- 测试13：批处理性能测试

### 第四部分：内存访问优化测试（1项）
- 测试14：内存优化效果测试

### 第五部分：压力和稳定性测试（2项）
- 测试15：长时间稳定性测试
- 测试16：随机输入压力测试

### 第六部分：整合文档第五章要求的额外测试（5项）
- 测试17：SM3标准测试向量验证（GB/T 32905-2016）
- 测试18：XOR折叠正确性详细测试
- 测试19：批处理正确性测试（8个相同块）
- 测试20：多线程正确性测试
- 测试21：SM3优化效果对比测试

**总计：20个综合测试**

---

## 🎯 测试目标验证

- ✅ SM3标准符合性（GB/T 32905-2016）
- ✅ XOR折叠正确性
- ✅ 批处理正确性
- ✅ 多线程正确性
- ✅ 性能目标（≥10x SHA256硬件加速）
- ✅ 雪崩效应（单比特变化影响）
- ✅ 输出分布均匀性
- ✅ 内存访问优化效果

---

## ⚠️ 注意事项

1. **平台要求**：
   - ARMv8.2-A或更高架构
   - 支持Crypto扩展（AES/SM3/SHA2/NEON）

2. **编译器要求**：
   - GCC 7.0+
   - 支持`-march=armv8.2-a+crypto`

3. **测试运行时间**：
   - 完整测试：约1-2分钟
   - 快速模式：约30秒

4. **内存需求**：
   - 最小：100MB
   - 推荐：256MB

---

## 🐛 故障排除

### 问题1：找不到文件

```bash
错误: 找不到 aes_sm3_integrity.c
```

**解决方案**：确保在正确的目录下执行脚本

### 问题2：编译选项不支持

```bash
error: unrecognized command line option '-march=armv8.2-a+crypto'
```

**解决方案**：脚本会自动使用备选编译选项

### 问题3：权限问题

```bash
Permission denied
```

**解决方案**：
```bash
chmod +x run_tests.sh compile_and_test.sh
```

---

## 📊 预期输出

测试成功时应显示：

```
╔══════════════════════════════════════════════════════════╗
║                   测试结果汇总                            ║
╚══════════════════════════════════════════════════════════╝

  总测试数:   20
  通过:       20
  失败:       0
  总耗时:     XX.XX秒

  ✓ 所有测试通过！
```

---

## 📚 相关文档

- `TEST_README.md` - 完整测试文档
- `测试文件说明.md` - 测试文件说明
- `快速测试指南.md` - 快速测试指南
- `整合文档.txt` - 项目整合文档（第五章测试要求）

