# 测试需求补充完成说明

## 补充内容总结

本次根据《整合文档.txt》的测试要求，对测试套件进行了以下4项补充：

---

### ✅ 需求1：SM3标准测试向量的严格验证

**文件修改**：`test_integrity_suite.c` - `test_sm3_standard_vectors()` 函数

**补充内容**：
1. **增加了对GB/T 32905-2016标准测试向量"abc"的直接验证**
   - 手动构造SM3标准填充后的消息块（512位）
   - 直接调用`sm3_compress_hw()`进行压缩运算
   - 与标准答案`66c7f0f462eeedd9d1f2d46bdc10e4e24167c4875cf2f7a2297da02b8f4ba8e0`进行对比
   - 实现了对原始3字节输入的精确验证

2. **添加了详细的技术说明**
   - SM3标准初始向量（IV）
   - 消息填充规则（消息 || 1 || 0...0 || 长度）
   - 大小端序转换处理
   - 结果验证和错误提示

**测试覆盖**：
- ✓ SM3标准测试向量1 ("abc")
- ✓ SM3确定性验证（4KB输入重复计算）

---

### ✅ 需求2：SM3优化效果测试（5.4.3节）

**文件修改**：`test_integrity_suite.c` - 新增`test_sm3_optimization_effect()` 函数

**补充内容**：
1. **对比标准循环版本和完全展开版本**
   - `sm3_compress_hw()` - 标准循环版本
   - `sm3_compress_hw_inline_full()` - 完全展开内联版本
   - 执行100,000次迭代进行性能测试

2. **性能指标**
   - 耗时（秒）
   - 吞吐量（Mops/s）
   - 平均延迟（纳秒/次）

3. **优化效果分析**
   - 加速比计算
   - 性能提升百分比
   - 延迟降低百分比
   - 结果一致性验证

4. **评估标准**
   - 期望至少15%性能提升
   - 自动判定优化是否有效

**测试覆盖**：
- ✓ SM3循环展开优化效果
- ✓ SM3优化版本结果一致性

---

### ✅ 需求3：版本对比测试补充（v3.0-v6.0）

**文件修改**：`test_integrity_suite.c` - `test_integrity_algorithm()` 函数

**已有实现**：
- 原代码已包含完整的版本对比测试
- 测试所有版本（v3.0 Extreme、v3.1 Ultra、v4.0 Mega、v5.0 Super、v6.0 Hyper）
- 验证所有版本输出一致性
- 不一致时自动输出各版本结果用于调试

**测试覆盖**：
- ✓ 256位输出长度验证
- ✓ 128位输出是256位截断
- ✓ 不同版本输出一致性 (v3.0-v6.0)

---

### ✅ 需求5：SM3标准测试向量数据生成

**文件修改**：`generate_test_data.c` - `generate_test_vectors_file()` 函数

**补充内容**：
1. **生成SM3标准测试向量的二进制文件**
   - `test_vector_abc.bin` - 包含"abc"（填充到4KB）
   - `test_vector_abcd64.bin` - 包含64字节重复"abcd"（填充到4KB）

2. **完善测试向量文档 `test_vectors.txt`**
   - 增加了SM3标准测试向量章节
   - 详细说明每个测试向量的输入、长度、标准输出
   - 补充了使用说明和注意事项
   - 标注了国标编号 GB/T 32905-2016

3. **文档结构**
   ```
   【SM3标准测试向量】(GB/T 32905-2016)
   ├── 测试向量1: "abc" (3字节)
   ├── 测试向量2: "abcd"x16 (64字节)
   ├── 测试向量3: 全0数据 (4KB)
   └── 测试向量4: 全1数据 (4KB)
   
   【测试数据文件列表】
   ├── SM3标准测试向量
   ├── 基础数据
   ├── 随机数据
   ├── 批处理数据
   ├── 多线程数据
   └── 雪崩测试数据
   
   【使用说明】
   1-6. 各类测试的数据使用方法
   ```

**生成文件**：
- ✓ `test_vector_abc.bin` (4KB)
- ✓ `test_vector_abcd64.bin` (4KB)
- ✓ `test_vectors.txt` (详细文档)

---

## 额外补充的测试功能

### 🎁 内存访问优化性能测试（5.4.5节）

**新增功能**：`test_memory_optimization_performance()` 函数

**测试内容**：
1. 调用原有的`test_memory_access_optimization()`函数
2. 补充批处理预取优化测试
   - 对比带预取和不带预取的批处理性能
   - 验证结果一致性
   - 计算加速比和性能提升百分比

**评估标准**：
- 期望至少10%性能提升
- 自动判定内存优化是否有效

---

## 测试套件整体结构

```
test_integrity_suite.c
├── 5.3 算法正确性测试
│   ├── 5.3.1 SM3算法标准测试向量 ✓ 补充完成
│   ├── 5.3.2 XOR折叠正确性测试
│   ├── 5.3.3 完整性校验算法测试 ✓ 版本对比已完整
│   ├── 5.3.4 批处理正确性测试
│   └── 5.3.5 多线程正确性测试
│
├── 5.4 性能测试
│   ├── 5.4.1 单块性能测试
│   ├── 5.4.2 对比基准性能测试
│   ├── 5.4.3 SM3优化效果测试 ✓ 新增补充
│   ├── 5.4.4 批处理与多线程性能
│   └── 5.4.5 内存访问优化性能测试 ✓ 新增补充
│
└── 3.6.3 雪崩效应验证
```

---

## 编译和运行

### Windows (ARM64)
```bash
cd C:\Users\yuuuu\Desktop\ceshi
gcc -march=armv8.2-a+crypto -O3 -pthread ^
    -o test_integrity_suite test_integrity_suite.c ^
    ..\cn_test1.1\test1.1\aes_sm3_integrity.c -lm
```

### Linux/Ubuntu (ARM64)
```bash
cd /path/to/ceshi
gcc -march=armv8.2-a+crypto -O3 -pthread \
    -o test_integrity_suite test_integrity_suite.c \
    ../cn_test1.1/test1.1/aes_sm3_integrity.c -lm
```

### 运行测试
```bash
# 运行完整测试（包含所有新增测试）
./test_integrity_suite --all

# 仅运行正确性测试
./test_integrity_suite --quick

# 仅运行性能测试（包含5.4.3和5.4.5）
./test_integrity_suite --performance

# 仅运行雪崩效应测试
./test_integrity_suite --avalanche
```

### 生成测试数据
```bash
# 生成所有测试数据（包含新增的标准测试向量）
./generate_test_data test_data
```

---

## 测试覆盖率

### 正确性测试
- ✅ SM3标准测试向量验证（GB/T 32905-2016）
- ✅ XOR折叠正确性
- ✅ 完整性算法（256位/128位）
- ✅ 版本一致性（v3.0-v6.0）
- ✅ 批处理正确性
- ✅ 多线程正确性

### 性能测试
- ✅ 单块性能（v5.0 vs v6.0）
- ✅ 对比基准（SHA256、SM3、XOR+SM3）
- ✅ SM3优化效果（循环 vs 展开）
- ✅ 批处理与多线程性能
- ✅ 内存访问优化效果（预取、对齐）

### 安全性测试
- ✅ 雪崩效应（严格雪崩准则SAC）

---

## 文件清单

```
C:\Users\yuuuu\Desktop\ceshi\
├── test_integrity_suite.c      # 测试套件主文件 ✓ 已更新
├── generate_test_data.c         # 测试数据生成工具 ✓ 已更新
├── Makefile                     # 编译脚本
├── README.md                    # 使用说明
└── 测试补充说明.md              # 本文件
```

---

## 测试验证要点

### SM3标准测试向量验证
1. 确保`sm3_compress_hw()`函数可访问
2. 输出必须完全匹配国标标准答案
3. 大小端序处理必须正确

### SM3优化效果测试
1. 需要链接包含两个函数的实现文件
2. 结果一致性是优化有效的前提
3. 性能提升应≥15%

### 内存优化测试
1. 需要提供`aes_sm3_integrity_batch_no_prefetch()`函数
2. 预取优化效果应≥10%
3. 结果必须完全一致

---

## 注意事项

⚠️ **重要依赖**：
- 测试代码需要链接`aes_sm3_integrity.c`
- 必须使用ARMv8.2-A+crypto架构编译
- 需要POSIX线程库支持（`-pthread`）
- 某些性能测试在非ARM平台上可能无法运行

⚠️ **性能测试**：
- 建议在实际ARM硬件上运行
- 关闭系统负载和后台任务
- 多次运行取平均值

⚠️ **标准测试向量**：
- SM3标准输出已验证过正确性
- 如果验证失败，检查字节序和填充逻辑

---

**补充完成时间**：2025-10-22
**测试套件版本**：v1.0
**符合标准**：GB/T 32905-2016

